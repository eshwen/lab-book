
\chapter{Service Work: Trigger Shifts at P5 (22/11/2017)}

To gain additional EPR credit that gets me closer to authorship, I should sign up for trigger shifts at P5. The url to sign up is \url{https://cmsonline.cern.ch/webcenter/portal/cmsonline/pages_common/shiftlist}. \uline{Once shifts open up, it's good to grab them as quickly as possible.} My shifts are:

\begin{easylist}
\ListProperties(Style*=$\bullet$ , FinalMark={)})
& 9th and 10th May 2018 (training shifts, first one with Simone, second with Wei Shi) -- 0700 to 1500
& 14th, 15th, 16th May 2018 -- 1500 to 2300
& 25th, 26th, 27th May 2018 -- 2300 to 0700
& 14th June 2018 -- 1500 to 2300
& 22nd, 23rd, 24th June 2018 -- 1500 to 2300
& 18th October 2018 -- 1500 to 2300
& 26th, 27th, 28th November -- 0700 to 1500
\end{easylist}

I needed to arrange training shifts, take some online courses (at \url{http://sir.cern.ch/}) and request CMS Control Room access, all of which are detailed at \url{https://twiki.cern.ch/twiki/bin/viewauth/CMS/TriggerShifterQuickTutorial#Prerequisites}.

For getting to P5 and back, there are shuttle buses that leave from CERN and some bus stops in St. Genis. The timetable is detailed at \url{https://smb-dep.web.cern.ch/en/ShuttleService/Circuit3}.

A tutorial session was run, detailing the basics of shifts. The slides are here: \href{run:modules/Sec 33 - Service Work Trigger Shifts at P5/figures/Trigger_shifter_tutorial_ - _Introduction_control_and_configuration.pdf}{Trigger shifter tutorial -- Introduction, control and configuration} and \href{run:modules/Sec 33 - Service Work Trigger Shifts at P5/figures/Trigger_shifter_tutorial_ - _Monitoring_troubleshooting_and_summary.pdf}{Trigger shifter tutorial -- Monitoring, troubleshooting and summary}.

\section{On shift}
\label{subsec:onP5shift}

When on shift, I essentially need to monitor the trigger subsystems and rates, and check everything is okay. When I first get into the Control Room, the previous shifter will tell me about anything noteworthy that happened on their shift. The monitors should already have the relevant pages loaded (like uGT SWATCH cell, L1Page, DQM monitoring, etc.). I should look at the previous shifter's elog on \url{https://cmsonline.cern.ch/}. I could find the logs by navigating to Elog $>$ Subsystems $>$ Trigger $>$ Trigger. I should also start my own elog for the shift using my template, logging the state of the run and system when my shift starts, as well when new runs start, the beam is dumped, etc (with the context surrounding it). I can check the rates on the page documented in the list below. The plot will show the L1 rate and usually three other triggers (belonging to EG, muons and jets, respectively). Hovering over a curve will give the trigger as a bit number. Then, I can navigate the table below to see which trigger corresponds to the number. At the end of the shift, I should upload my elog.

During stable beams, the prescale column in the uGT SWATCH cell -- in uGT SWATCH Cell
$>$ Control Panels $>$ uGT Prescales -- is arguably the most important thing to keep an eye on. The prescale for a trigger effectively controls the rate. If the prescale for a particular trigger is 1, then an object that would normally fire this trigger will. If the prescale is 2, then half of the trigger firings are recorded. This is useful as there are different triggers for different situations, which therefore require different prescales. Some low-threshold triggers can be useful for calibrations, but can cause very high rates in stable beams, so their prescale is set very high. The prescale columns are usually either bunch-based or lumi-based. When running early in the year and we're ramping up, there's a different amount of bunches at any one time. Whereas later in the year when everything is stable and we run with a set amount of bunches, the prescales should be changed depending on luminosity. The luminosity can be found by checking some of the monitors, and is usually at its highest at the start of a run, and gradually decreases throughout. The prescale column will likely need changing $\order{1 \text{ hour}}$.

The rates, tied to the prescales, are also an important thing to check. During stable beams, the L1 rate should be around 40 MHz (but can reach around 65 MHz at the start of a run as there are more protons in the LHC and so a higher PU) and the HLT rate should be around 1 kHz. If the rates are out of control due to a suspected hot tower, the DQM plots should be checked. These plots are accessible at URL, and hold information from the last 1000 lumi sections. Right-clicking on a plot gives options to adjust the range, or checking for hot towers with \texttt{drawoption = hottowers}.



Some useful links are

\begin{easylist}
\easylistprops
& Online trigger workbook: \url{https://twiki.cern.ch/twiki/bin/viewauth/CMS/OnlineWBTrigger}
& Prescale information (\emph{always load this when I start my shift and when a new run starts as there may be important key/prescale information added}): \url{https://twiki.cern.ch/twiki/bin/view/CMS/OnlineWBL1CollisionPrescales}
& Main Level-1 page monitoring: \url{https://l1page.cms/}
& uGT SWATCH cell: \url{http://l1ts-ugt.cms:3333/urn:xdaq-application:lid=13/#!/Control%20Panels/1.%20Summary}
& Rates page: \url{cmswbm.cms/cmsdb/servlet/TriggerRatesHTML5}
& CMS online page: \url{https://cmsonline.cern.ch/webcenter/portal/cmsonline}
& Trigger shifter elog page: \url{https://cmsonline.cern.ch/webcenter/portal/cmsonline/pages_common/elog?wc.contentSource=}
& Lumi monitoring: \url{https://op-webtools.web.cern.ch/vistar/vistars.php?usr=LHC1}
& DAQ status: \url{http://cmsonline.cern.ch/daqStatusSCX/aDAQmon/DAQstatusGre.jpg}
& Current rate: \url{es-cdaq.cms/sc/ratemeter.html}
\end{easylist}

I should remember to bring lunch, my laptop (for working when nothing interesting is happening), my laptop charger and a Swiss plug adapter.


\section{Calo Layer-2 on call}

In addition to shifts, I'm expected to sign up as a Layer-2 on-call person. I'm basically given the on-call phone for a shift -- each shift being a week long and being expected to do four shifts over the year -- and give advice to whomever rings it.

The shifts I've chosen are

\begin{easylist}
\ListProperties(Style*=$\bullet$ , FinalMark={)})
& Weeks 17 and 18 -- 23rd April to 7th May 2018
& Week 24 -- 11th to 18th June 2018
& Week 26 -- 25th June to 2nd July 2018
& Week 47 -- 19th to 26th November 2018
\end{easylist}

I'll also have to attend extra meetings, which can be found at \url{https://twiki.cern.ch/twiki/bin/view/CMS/CaloLayer2OnCall#Meetings_to_attend_while_on_call} and in my Evernote note.

There are several tutorials and instructions that are helpful when dealing with a call: \href{run:modules/Sec 33 - Service Work Trigger Shifts at P5/figures/calo2-oncall-tutorial-dqm.pdf}{calo2-oncall-tutorial-dqm.pdf}, \href{run:modules/Sec 33 - Service Work Trigger Shifts at P5/figures/caloLayer2onCall_onlineSW_02032018.pdf}{caloLayer2onCall\_onlineSW\_02032018.pdf}, \href{run:modules/Sec 33 - Service Work Trigger Shifts at P5/figures/Tutorial_May_2017_v1.pdf}{Tutorial\_May\_2017\_v1.pdf}.

I got a call from the L1DOC about an input link error (crcError) on MP5, which is a known problem among Calo Layer-2 and shouldn't be a cause for concern. But Calo Layer-2 was briefly in error (likely from a "blip" where a couple of components were in error, flagging the entire subsystem in that state). A single component warning/error can send the entire subsystem into an "error" state, even though basically everything is fine. The current trigger shifter who noticed the error wrote an e-log detailing it. These will be in the same place as the normal shift logs (see~\ref{subsec:onP5shift}. I could also write replies to the e-logs to reassure the shifter that there's no real problem so they don't call me or the L1DOC throughout the night. I also posted about the problem on the CaloL2 Ops Skype chat to let everyone know.


\subsection{Setting up a tunnel to P5}

For online DQM (Data Quality Monitoring) and maintenance of the Trigger (like the L1 Page, etc.), I need to set up an ssh tunnel to P5. This is because the relevant webpages and information are only available from within the P5 network. The instructions are at \url{https://twiki.cern.ch/twiki/bin/viewauth/CMS/CaloLayer2OnCall}. First, on my computers, I opened \textbf{$\sim$/.profile} and added this line:

\begin{lstlisting}[belowskip=-0.7cm, language=sh, numbers=none]
alias p5tun='ssh -tN -v -4  -D 55555 ebhal@cmsusr.cern.ch -o "ProxyCommand=ssh ebhal@lxplus.cern.ch -W %h:%p"'
\end{lstlisting}

Then I downloaded the FoxyProxy add-on for Firefox (not Chrome as suggested) and followed the instructions to set it up. Then I followed the link \url{https://gitlab.cern.ch/cactus/cms-ca} to install the CMS Level-1 Software Certificate Authority certificate in my browser. I also added my grid certificate (see Sec~\ref{subsec:flattreeprodCMG}) to lxplus. Once those were completed, I can now just type

\begin{lstlisting}[belowskip=-0.7cm, language=sh, numbers=none]
p5tun
\end{lstlisting}

into my terminal to tunnel to P5. I will be prompted twice for passwords: the first is just my password for CERN's lxplus; the second is the password for my P5/cmsusr/.CMS account, which is my normal password with normal numbers. If I open Firefox, go to \url{https://l1page.cms/} and it loads, it means the tunnel is working. \textbf{UPDATE:} newer versions of Firefox aren't very compatible with FoxyProxy so I've also set it up on Chrome on both my laptops.

